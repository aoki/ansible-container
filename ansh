#!/bin/bash -e

set -o pipefail

trap 'printf "\nAborted. Bye ğŸ‘‹\n"; exit 1' 1 2 3 15

# Set inventory
inventory=$(ls inventories | fzf --reverse --header "ğŸ“¦ Choose inventory")
echo "ğŸ“¦ : ${inventory}"

# Set target hosts
hosts=$(cat inventories/${inventory}/hosts | grep '^\[' | grep -v vars | tr -d '[]' | fzf -m --reverse --header "âœ¨ Choose target hosts"| tr '\n' ',' | rev | cut -c 2- | rev)
echo "âœ¨ : ${hosts}"

# Set play book
playbook=$(ls playbooks/*.yml | fzf --reverse --header "ğŸ“š Choose playbook")
echo "ğŸ“š : ${playbook}"


read -r -p "ğŸ¤”{ Using --check mode? [y/N] (default: N): " res
printf "\n"
case $res in
  [yY]|[yY]es|yes|YES) check='--check';;
esac

command="ansible-playbook ${check} --diff -i inventories/${inventory} -l ${hosts} ${playbook} ${@:1}"

printf "ğŸ–¥  â¯ \033[0;32m%s\033[0m\n" "${command}"
read -r -p "ğŸ¤”{ Can I execute this command? [y/N] (default: N): " res
printf "\n"
case $res in
  [yY]|[yY]es|yes|YES)
    ${command}
    ;;
  *) printf "Canceled. Bye ğŸ‘‹\n";;
esac
